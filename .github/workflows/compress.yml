name: Compress HEVC
on: push

permissions:
  contents: write

jobs:
  compress:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Download from Google Drive
        run: |
          pip install gdown
          gdown "1rGfGzDoZrwxVEBTyKOo1yGJZlmATvROd" -O "PantH.mov"
      
      - name: Install ffmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3
      
      - name: Compress MOV with alpha to 5MB
        run: |
          DURATION=$(ffprobe -v error -show_entries format=duration \
          -of default=noprint_wrappers=1:nokey=1 "PantH.mov")
          echo "Duration: $DURATION seconds"
          BITRATE=$(awk "BEGIN {printf \"%d\", 5 * 8192 / $DURATION}")
          echo "Target bitrate: ${BITRATE}k"
          ffmpeg -y -i "PantH.mov" \
          -c:v prores_ks \
          -profile:v 4444 \
          -quant_mat hq \
          -b:v ${BITRATE}k \
          -pix_fmt yuva444p10le \
          "PantH_small.mov"
          ls -lh PantH_small.mov
      
      - name: Commit compressed file
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add PantH_small.mov
          git commit -m "Compressed PantH MOV with alpha"
          git push
